<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YML Parser</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        #log {
            white-space: pre-wrap;
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #1177bb;
        }
        .success {
            color: #4ec9b0;
        }
        .error {
            color: #f48771;
        }
        .info {
            color: #9cdcfe;
        }
    </style>
</head>
<body>
    <h1>YML Catalog Parser</h1>
    <button onclick="fetchAndParse()">Fetch & Parse YML</button>
    <button onclick="downloadTS()" id="downloadBtn" style="display:none">Download products.ts</button>
    <div id="log"></div>

    <script>
        const YML_URL = 'https://xn--80aqga1abihi8b9a.xn--p1ai/tstore/yml/6b06c1ebf3dc86f07bfa1c2120e387d4.yml';
        let generatedCode = '';

        const categoryMap = {
            '418454360332': 'mother-day', // –î–ª—è –º–∞–º—ã
            '903544273382': 'girl', // 8 –º–∞—Ä—Ç–∞
            '938185508832': 'girl', // –î–µ–≤—É—à–∫–∞–º
            '677890623652': 'man', // –ú—É–∂—á–∏–Ω–∞–º
            '647172376882': 'man', // 23 —Ñ–µ–≤—Ä–∞–ª—è
            '480949580162': 'father-day', // –î–µ–Ω—å –æ—Ç—Ü–∞
            '363431731972': 'girl-kid', // –î–µ–≤–æ—á–∫–∞–º
            '804474588952': 'boy-kid', // –ú–∞–ª—å—á–∏–∫–∞–º
            '551418870082': 'discharge', // –í—ã–ø–∏—Å–∫–∞
            '859134485432': 'gender-party', // –ì–µ–Ω–¥–µ—Ä-–ø–∞—Ç–∏
            '388216421102': 'one-year', // –®–∞—Ä—ã –Ω–∞ –≥–æ–¥–∏–∫
            '486770416472': 'girl', // –î–µ–≤–∏—á–Ω–∏–∫
            '669122245592': 'other', // 14 —Ñ–µ–≤—Ä–∞–ª—è
            '715576008962': 'other', // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
            '271055827892': 'other', // –ë–æ–ª—å—à–∏–µ —à–∞—Ä—ã
            '346524345142': 'other', // –ö–æ—Ä–æ–±–∫–∞ - —Å—é—Ä–ø—Ä–∏–∑
            '649091827462': 'other', // –ë–æ–∫—Å—ã
            '620575166392': 'other', // –¶–∏—Ñ—Ä—ã
            '363354784102': 'other', // –§–æ–ª—å–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–≥—É—Ä—ã
            '501977884172': 'other', // –ù–æ–≤—ã–µ 2025
            '344791042122': 'other', // All
            '146241468622': 'other', // –ü–æ–¥—Ä–æ—Å—Ç–∫–æ–≤—ã–π 2025
            '487288603682': 'other', // –§–æ—Ç–æ–±–∞–Ω–∫ 6.0
        };

        function log(message, className = '') {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.textContent = message;
            if (className) line.className = className;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function extractColors(text) {
            const colorMap = {
                '—Ä–æ–∑–æ–≤—ã–π': ['—Ä–æ–∑–æ–≤—ã–π', '—Ä–æ–∑–æ–≤–∞—è', '—Ä–æ–∑–æ–≤—ã–µ', '—Ä–æ–∑–æ–≤–æ–º'],
                '—Å–∏–Ω–∏–π': ['—Å–∏–Ω–∏–π', '—Å–∏–Ω—è—è', '—Å–∏–Ω–∏–µ', '—Å–∏–Ω–µ–º'],
                '–∫—Ä–∞—Å–Ω—ã–π': ['–∫—Ä–∞—Å–Ω—ã–π', '–∫—Ä–∞—Å–Ω–∞—è', '–∫—Ä–∞—Å–Ω—ã–µ', '–∫—Ä–∞—Å–Ω–æ–º'],
                '–±–µ–ª—ã–π': ['–±–µ–ª—ã–π', '–±–µ–ª–∞—è', '–±–µ–ª—ã–µ', '–±–µ–ª–æ–º'],
                '—á–µ—Ä–Ω—ã–π': ['—á–µ—Ä–Ω—ã–π', '—á–µ—Ä–Ω–∞—è', '—á–µ—Ä–Ω—ã–µ', '—á–µ—Ä–Ω–æ–º'],
                '–∑–æ–ª–æ—Ç–æ–π': ['–∑–æ–ª–æ—Ç–æ–π', '–∑–æ–ª–æ—Ç–∞—è', '–∑–æ–ª–æ—Ç—ã–µ', '–∑–æ–ª–æ—Ç–æ–º', '–∑–æ–ª–æ—Ç–æ'],
                '—Å–µ—Ä–µ–±—Ä—è–Ω—ã–π': ['—Å–µ—Ä–µ–±—Ä—è–Ω—ã–π', '—Å–µ—Ä–µ–±—Ä—è–Ω–∞—è', '—Å–µ—Ä–µ–±—Ä—è–Ω—ã–µ', '—Å–µ—Ä–µ–±—Ä–æ'],
                '–∑–µ–ª–µ–Ω—ã–π': ['–∑–µ–ª–µ–Ω—ã–π', '–∑–µ–ª–µ–Ω–∞—è', '–∑–µ–ª–µ–Ω—ã–µ', '–∑–µ–ª–µ–Ω–æ–º'],
                '–∂–µ–ª—Ç—ã–π': ['–∂–µ–ª—Ç—ã–π', '–∂–µ–ª—Ç–∞—è', '–∂–µ–ª—Ç—ã–µ', '–∂–µ–ª—Ç–æ–º'],
                '—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π': ['—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π', '—Ñ–∏–æ–ª–µ—Ç–æ–≤–∞—è', '—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ', '—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–º'],
                '–≥–æ–ª—É–±–æ–π': ['–≥–æ–ª—É–±–æ–π', '–≥–æ–ª—É–±–∞—è', '–≥–æ–ª—É–±—ã–µ', '–≥–æ–ª—É–±–æ–º'],
                '–æ—Ä–∞–Ω–∂–µ–≤—ã–π': ['–æ—Ä–∞–Ω–∂–µ–≤—ã–π', '–æ—Ä–∞–Ω–∂–µ–≤–∞—è', '–æ—Ä–∞–Ω–∂–µ–≤—ã–µ', '–æ—Ä–∞–Ω–∂–µ–≤–æ–º'],
                '–ø–µ—Ä—Å–∏–∫–æ–≤—ã–π': ['–ø–µ—Ä—Å–∏–∫–æ–≤—ã–π', '–ø–µ—Ä—Å–∏–∫–æ–≤–∞—è', '–ø–µ—Ä—Å–∏–∫–æ–≤—ã–µ', '–ø–µ—Ä—Å–∏–∫–æ–≤–æ–º', '–ø–µ—Ä—Å–∏–∫'],
                '–º—è—Ç–Ω—ã–π': ['–º—è—Ç–Ω—ã–π', '–º—è—Ç–Ω–∞—è', '–º—è—Ç–Ω—ã–µ', '–º—è—Ç–Ω–æ–º', '–º—è—Ç–∞'],
            };
            
            const lowerText = text.toLowerCase();
            const foundColors = [];
            
            for (const [baseColor, variants] of Object.entries(colorMap)) {
                for (const variant of variants) {
                    if (lowerText.includes(variant)) {
                        if (!foundColors.includes(baseColor)) {
                            foundColors.push(baseColor);
                        }
                        break;
                    }
                }
            }
            
            return foundColors;
        }

        function parseYML(xml) {
            const products = [];
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xml, 'text/xml');
            
            const offers = xmlDoc.querySelectorAll('offer');
            log(`Found ${offers.length} offers`, 'info');
            
            offers.forEach(offer => {
                const id = offer.getAttribute('id');
                const nameEl = offer.querySelector('name');
                const priceEl = offer.querySelector('price');
                const categoryEl = offer.querySelector('categoryId');
                const pictureEl = offer.querySelector('picture');
                const descEl = offer.querySelector('description');
                
                if (!nameEl || !priceEl) return;
                
                const name = nameEl.textContent.trim();
                const price = parseFloat(priceEl.textContent);
                const categoryId = categoryEl ? categoryEl.textContent : '';
                const picture = pictureEl ? pictureEl.textContent.trim() : '';
                const description = descEl ? descEl.textContent.replace(/<[^>]*>/g, '').trim() : '';
                
                const category = categoryMap[categoryId] || 'other';
                const colors = extractColors(name + ' ' + description);
                
                const product = {
                    id,
                    name,
                    price,
                    image: picture,
                    category,
                };
                
                if (colors.length > 0) product.colors = colors;
                if (description) product.description = description;
                
                products.push(product);
            });
            
            return products;
        }

        async function fetchAndParse() {
            try {
                document.getElementById('log').innerHTML = '';
                log('üì• Downloading YML catalog...', 'info');
                
                const response = await fetch(YML_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const xml = await response.text();
                log(`‚úì Downloaded ${Math.round(xml.length / 1024)}KB`, 'success');
                
                log('üîç Parsing products...', 'info');
                const products = parseYML(xml);
                log(`‚úì Found ${products.length} products`, 'success');
                
                // Generate TypeScript code
                const tsCode = `// Auto-generated from YML catalog
// Date: ${new Date().toISOString()}
// Source: Baloo balloon shop
// Total products: ${products.length}

export interface Product {
  id: string;
  name: string;
  price: number;
  image: string;
  category: 'girl' | 'man' | 'girl-kid' | 'boy-kid' | 'discharge' | 'gender-party' | 'one-year' | 'father-day' | 'mother-day' | 'other';
  colors?: string[];
  description?: string;
}

export const products: Product[] = ${JSON.stringify(products, null, 2)};
`;
                
                generatedCode = tsCode;
                document.getElementById('downloadBtn').style.display = 'inline-block';
                
                // Statistics
                const categories = products.reduce((acc, p) => {
                    acc[p.category] = (acc[p.category] || 0) + 1;
                    return acc;
                }, {});
                
                log('\nüìä Products by category:', 'info');
                Object.entries(categories)
                    .sort((a, b) => b[1] - a[1])
                    .forEach(([cat, count]) => {
                        log(`   ${cat.padEnd(15)} : ${count}`);
                    });
                
                const withColors = products.filter(p => p.colors && p.colors.length > 0).length;
                const withDescriptions = products.filter(p => p.description).length;
                
                log('\nüìà Additional stats:', 'info');
                log(`   With colors      : ${withColors} (${Math.round(withColors / products.length * 100)}%)`);
                log(`   With description : ${withDescriptions} (${Math.round(withDescriptions / products.length * 100)}%)`);
                
                log('\n‚úÖ Ready to download!', 'success');
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function downloadTS() {
            const blob = new Blob([generatedCode], { type: 'text/typescript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'products.ts';
            a.click();
            URL.revokeObjectURL(url);
            log('\n‚úÖ Downloaded products.ts', 'success');
        }
    </script>
</body>
</html>
